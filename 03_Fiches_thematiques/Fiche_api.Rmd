# Travailler avec des API

<!-- ## Tâches concernées et recommandations -->

<!-- Quelques détails sur la tâche dont il s'agit -->

<!-- ::: {.recommandation data-latex=""} -->

<!-- Dire en 4-5 lignes comment il est recommandé de procéder: -->

<!-- * le ou les *package*(*s*) dont l'usage est recommandé; si on recommande plusieurs *packages*, expliquer comment choisir lequel (en fonction de la taille des données, du format...) -->
<!-- * les *packages* dont l'usage est déconseillé;  -->
<!-- * les autres points de méthode essentiels. -->

<!-- ::: -->

## Rappels des notions essentielles sur les API

### Qu'est ce qu'une API ?

Une *Application Programming Interface* (ou **API**) est une interface applicative de programmation qui permet d'utiliser une application existante pour restituer des données. Il s'agit d'une façade clairement délimitée par laquelle un logiciel offre des services à d'autres logiciels (ou utilisateurs). L'objectif est de fournir une porte d'accès à une fonctionnalité en cachant les détails de la mise en œuvre. 

Ce terme peut faire peur, mais il s'agit en fait simplement d'une façon de restituer des données. Plutôt que d'attaquer directement des bases de données, qui sont volumineuses et complexes, des outils ont été développés pour faire le travail intermédiaire et restituer la données sous forme de service.

À l'Insee comme ailleurs, la connexion inter bases de données pour les nouveaux projets tend à se réaliser via des API, afin de limiter le nombre de personnes ayant accès aux bases, mais aussi pour faciliter les accès avec des services sur-mesures pour les utilisateurs.

### Mise à disposition des API

Les API peuvent ou non utiliser un interface utilisateur.
Les API Insee mise à disposition sur le [catalogue des API](https://api.insee.fr/catalogue/) proposent une interface utilisateur. Cette interface, permet :
- de s'inscrire aux différents services;
- de visualiser les différentes requêtes proposées par les services;
- de lancer l'API depuis cette plateforme;
- de documentater les API.
Cependant, l'utilisation de cette interface ne vous servira pas très longtemps, car vous allez vite vous rendre compte qu'une API s'utilise via un logiciel de traitement pour automatiser un processus ou réaliser du chargement de masse.


Pour d'autres API, mise à disposition de la [BDM au format SDMX](https://www.insee.fr/fr/information/2862759), ce point d'entré n'existe pas. De la documentation est mise à disposition pour permettre à l'utilisateur de comprendre l'utilisation du service. L'utilisateur devra ensuite utiliser l'API directement via son url par son navigateur internet ou un logiciel adapté (R, java, python...).

Les API sont porposées avec plusieurs degrés de liberté pour l'utilisteur :
- soit en libre accès. L'utilisation n'est ici pas contrôlée et peut utiliser le service comme bon lui semble ;
- soit via la génération d'un compte et d'un jeton qui permet de sécuriser son utilisation et limiter le nombre de requêtes.

### Requête d'une API

Comme pour l'utilisation d'une fonction ou d'une macro SAS, l'appel d'une API s'effectue via des paramètres. 
Chaque service se présente sous la forme d'une url. Cette url est à compléter avec les différents paramètres de la requête.

Prenons l'exemple de l'API Sirene, l'url a utiliser pour avoir des informations sur un siren est : https://api.insee.fr/entreprises/sirene/V3/siren/{siren} (modifier {siren} en renseignant le numéro du siren).

Chaque service proposé par l'API aura sa propre url avec ses propres paramètres.

Enfin, le résultat envoyé par une API est majoritairement du json ou de l'XML. Cependant certains service peuvent proposer du csv.
Le résultat n'est pas toujours facile à récupérer. Pour faciliter les utilisations des API, des packages ont été créé pour simplifier l'utilisation. Malheureusement tous les services d'API ne possèdent pas un package. Dans ce cas, il va falloir que l'utilisation détricotte le résultat pour obtenir des données lisibles.

## Package de hauts vols permettant une utilisation simple des API

Nous allons voir ici quelques packages permettant de traiter l'information d'une API facielement :

### [apinsee](https://github.com/InseeFrLab/apinsee)

Ce package est trés utile pour l'utilisation des API mises à diposition sur le catalogue des API. En effet, pour ces API, un jeton ayant une durée de vie limitée doit être régulièrement généré. Ce package, va automatiquement créer un jeton lorsqu'on l'appelle. Ainsi il n'y a plus besoin de naviguer entre le programme et et le catalogue des API.

```{r, eval = FALSE}
# Dans un premier temps il faut modifier son .Renviron, en utilisant la commande usethis::edit_r_environ("user").
# Ces deux lignes doivent être ajoutée : 
# Dans un premier temps il faut modifier son .Renviron, en utilisant la commande :
usethis::edit_r_environ("user")
# Ces deux lignes doivent être ajoutée. Ces informations se trouvent dans la partie clé et jeton d'accès du portail des API : 
INSEE_APP_KEY=xxxxxxxxxxxxxxxxxx    # clef du consommateur
INSEE_APP_SECRET=yyyyyyyyyyyyyyyyyy # secret du consommateur

# Vous pouvez donc simplement exécuter la fonction :
token <- apinsee::insee_auth()

# Ce token peut ensuite être utilisé comme valeur du paramètre token de la fonction httr::config() :

library(httr)
set_config(config(token = token))

# Dès lors, vous pouvez accéder aux API de l’Insee auxquelles votre application a souscrites.

```

### [insee](https://hadrilec.github.io/insee/)

Ce package permet de télécharger les données et leur métadonnées diffusées sur le service SDMX de la Base de données Macroéconomique de l'Insee (BDM). Cette API étant ouverte, l'accès à cette API ne demande pas d'identification, ni de jeton. Il est uniquement nécessaire de déterminer les données souhaitées soit via une liste idbank, soit via une liste de dataset. 
Voici quelques utilisations possible de ce package :

Obtenir la liste des tables présentes dans la BDM , les dataset, ou la liste des séries proposées, les idbank :

```{r, eval = FALSE}
liste_table <- get_dataset_list()
liste_indicateur <- get_idbank_list()

```

Importer les données à partir de leur idbank ou importer un dataset à partir de leur identifiant:
```{r, eval = FALSE}
table_bp <- get_insee_dataset("BALANCE-PAIEMENTS")
indicateur_001694056 <- get_insee_idbank("001694056")

```
Il est possible de rajouter des filtres à ces fonctions ain de limiter le nombre de données importée (filtre sur la période, sur la date de mise à jour, sur les filtres).



::: {.conseil data-latex=""}

Cette boîte colorée sert à donner un conseil. Son usage n'est évidemment pas obligatoire.

:::

::: {.remarque data-latex=""}

Cette boîte colorée sert à faire une remarque. Son usage n'est évidemment pas obligatoire.

:::

### Réaliser la tâche, cas 1

Lorsqu'on est débutant, il faut utiliser la fonction `super_fonction()` du *package* `super_package`.

La fonction `super_fonction()` fonctionne comme ceci par défaut: blabla.

La fonction `super_fonction()` propose beaucoup d'options:

* `option1`: blabla;
* `option2`: blabla;
* `option3`: blabla.

Voici un premier exemple de code (le plus simple possible, en utilisant des données facilement disponibles sur le site de l'Insee):

```{r, eval = FALSE}
library(super_package)
output <- super_fonction(arguments)
```

Ne pas oublier d'expliquer ce qu'on obtient comme output.

Voici un second exemple de code, avec des options un peu plus avancées:

```{r, eval = FALSE}
output <- super_fonction(arguments et options)
```


### Réaliser la tâche, cas 2

Lorsqu'on est plus avancé, on peut utiliser la fonction `hyper_fonction()` du *package* `hyper_package`.

* Comportement par défaut;
* Principales options;
* Exemples de code.

## Quelques bonnes pratiques

Quelques conseils généraux sur la façon de s'y prendre.

* Faut-il préprocesser les données avant de réaliser la tâche;
* Comment minimiser les temps de calculs/la charge en RAM.

## Sources

Si le rédacteur de la fiche a réutilisé des ressources externes en français disponible en licence libre, il faut indiquer ici l'URL des ressources, le nom des auteurs et la licence de réutilisation de ces ressources.

## Ressources

* la documentation des *packages*;
* les vignettes et *cheatsheets* si elles existent;
* les formations proposées par l'Insee;
* les formations/tutoriels disponibles sur internet.

Dans la mesure du possible, il faut veiller à proposer des ressources en français.
