# Importer des fichiers plats (`.csv`, `.tsv`, `.txt`)

## Tâches concernées et recommandations

L'utilisateur souhaite importer dans `R` des données stockées sous forme de fichiers plats (formats `.txt`, `.csv`, `.tsv`).

::: recommandation
**Recommandations de l'Insee**

* Pour importer des données de taille réduite (jusqu'à 1 Go), **il est recommandé d'utiliser les fonctions `read_csv()` et `read_delim()` du *package* `readr`**;
* Pour importer des données de taille plus importante (supérieure à 1 Go), **il est recommandé d'utiliser la fonction `fread()` du *package* `data.table`**.
* **L'usage du *package* `csvread` est déconseillé**, de même que l'utilisation des fonctions natives de `R` `read.csv()` et `read.delim()`.
:::

## Importer des fichiers plats en `R`

## Fichiers de taille limitée:  le package `readr`

Le package `readr` propose plusieurs fonctions parfaitement adaptées pour importer des fichiers plats de taille limitée (moins de 1 Go):

* `read_csv()` : lecture d'un csv délimité par des virgules, avec un point comme marqueur décimal;
* `read_csv2()` : lecture d'un csv séparé par des points-virgules, avec une virgule comme marqueur décimal;
* `read_delim()` : fonction plus générale et paramétrable, pour lire des fichiers délimités.

Il faut charger le *package* `readr` pour utiliser ces fonctions:

```{r} library(readr)```.

::: conseil
**Conseils**

* Si vous êtes débutants en `R`, il est recommandé d'utiliser l'utilitaire d'importation de `Rstudio`. Une fois que les données sont correctement importées, vous pouvez copier-coller le code dans votre script `R`. 
* Si vous connaissez déjà `R`, vous pouvez utiliser directement les fonctions du *package* `readr`.
:::

### Utiliser l'assistant d'importation `Rstudio`

Pour les utilisateurs débutants, `Rstudio` propose une interface graphique très commode pour importer des fichiers plats avec `readr`. On y accède avec: `File > Import Dataset > From text (readr)...`. On obtient la fenêtre suivante. En cliquant sur `Browse` (rectangle rouge), on peut définir le chemin du fichier que l'on souhaite importer.

![](./pics/Importer_csv/Interface_readr1-1.png){width=100%} 

Une fois que le fichier à importer a été sélectionné, un aperçu des premières lignes du fichier s'affiche dans la fenêtre. Dans l'exemple ci-dessous, on essaie d'importer le fichier des communes du Code Officiel Géographique (version 2019). La fenêtre comprend deux panneaux très utiles:

* Un panneau qui permet de définir les **options d'importation** (rectangle orange);
* Un panneau qui donne le **code qui réalise l'importation demandée** (rectangle vert).

![](./pics/Importer_csv/Interface_readr2-1.png){width=100%} 

Les principales options d'importation comprennent notamment:

* `Name`: Le nom du `data.frame` dans lequel les donnée seront stockées;
* `First Row as Names`: à cocher si la première ligne contient les noms de colonnes;
* `Delimiter`: Indique le délimiteur des données. Pour mémoire: `Comma` = virgule, `Semicolon` = point virgule, `Tab` = tabulation, `Whitespace` = espace, `Other...` = autre (à définir);
* `Locale...`: définit les options locales d'importation, notamment l'encodage et le marqueur décimal qui sont des sources récurrentes de problèmes;
* `NA`: indique la valeur retenue lorsqu'une valeur est manquante.

Enfin, il est possible de modifier le type des données en cliquant sur la petite flèches à côté de l'en-tête de colonne (flèches noires).

### Utiliser `read_delim()` et `read_csv()`


La fonction  `read_delim()` du *package* `readr` est faite pour lire toutes sortes de fichiers plats, et proposent un grand nombre d'options. Les fonctions `read_csv()` `read_csv2()` sont des versions simplifiées de `read_delim()`, adaptée au cas des fichiers `.csv`.

Voici les principales options de `read_csv()`:

| Argument  | Valeur par défaut | Fonction                                                       |
|-----------|-------------------|----------------------------------------------------------------|
| file      | Aucune            | Le chemin du fichier à importer                                |
| col_names | TRUE              | La première ligne contient-elle les noms de colonne?           |
| col_types | NULL              | Définir le type des variables                                  |
| skip      | 0                 | Sauter les n premières lignes (0 par défaut)                   |
| n_max     | Inf               | Nombre maximum de lignes à importer (pas de limite par défaut) |
| locale    |                   | Réglages locaux (encodage, marqueur décimal...)                |

Par défaut, la fonction `read_csv()` tente de deviner le type des variables (*integer* pour les nombres entiers, *double* pour les nombres décimaux, *character* pour les chaînes de caractères...). Toutefois, il peut arriver que vous souhaitiez préciser le type des variables lorsque le comportement par défaut ne convient pas. Pour cela, il faut utiliser l'option `col_types` et construire donnant le type de la variable considérée. On écrit: `nom_variable1 = col_integer()` pour imposer le type *integer*, `nom_variable2 = col_character()` pour impose le type *character*, etc.

Dans l'exemple qui suit, on veut importer le fichier des communes du code officiel géographique, en déclarant que le fichier est encodé en UTF-8 et en imposant que le code commune soit lu comme une chaîne de caractères et le code région comme un nombre entier. On écrit le code suivant: 

```{r, eval = FALSE}
library(readr)
communes <- read_csv("D:/K2KFED/communes-01012019.csv", 
                     locale = locale(encoding ="UTF-8"),
                     col_types = c(com = col_character(),
                                   reg = col_integer())
                     )
```



## `fread()`

* encoding;
* choix du séparateur;
* sélection de variables;
* type des variables;
* barre de progrès.

```r
library(data.table)
df <- fread()
```

## Bonnes pratiques

Voici quelques conseils à avoir en tête pour importer des données:

* **Vérifier que votre machine peut charger les données**: `R` importe les données dans la mémoire vive de la machine. Si vos données sont d'une taille supérieure à celle de la mémoire vive, vous ne pourrez pas les importer.
* Il est important d'**importer peu de colonnes**. Bien sélectionner les colonnes permet souvent de réduire significativement la taille des données et de résoudre le problème mentionné au point précédent. Les deux `packages` recommandés permettent de sélectionner des colonnes (option `` pour `readr` et option `select` pour `data.table`)
* Choisir le package en fonction du format de sortie (`tibble` versus `data.table`)
* Bien choisir le format des colonnes.

## Ressources

* doc de fread
* doc de data.table
* éventuelle fiche sur les types de données en R.



