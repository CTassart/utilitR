# Fiches de documentation

## Importer des fichiers plats (`.csv`, `.tsv`, `.txt`)

### Tâches concernées

L'utilisateur souhaite importer dans `R` des données stockées sous forme de fichiers plats (format `.txt`, `.csv`, `.tsv`).

### Recommandations

En HTML/CSS (mais pas seulement), les deux principaux types de rendus (`display`) sont `block` et `inline`. Par défaut, un élement qui a son `display` de type `block` prend toute la largeur et "repousse" les autres élements vers le haut et le haut. Un élément qui a un `display` de type `inline` se comporte "en ligne" : les élements qui le précédent et le suivent le "collent" horizontalement.

Tout ça pour dire que pour faire un bloc, il nous faut un élément avec un `display` de type `block`... ok, c'était trivial.

En HTML, l'élément "neutre" de type `block` est un `<div></div>` (l'élement inline neutre est le `<span></span>`).

Des éléments équivalents existent en markdown, voir <https://pandoc.org/MANUAL.html#divs-and-spans>.

Si on écrit en markdown :

```markdown
::: cops
Recommandation du COPS
:::
```

le HTML généré par Pandoc sera un élement `div` :

```html
<div class="cops">
<p>Recommandation du COPS</p>
</div>
```

L'utilisation d'une classe (ici `cops`) va être très utile car elle va nous permettre d'appliquer un style uniforme à tous les éléments de classe `cops`.

Maintenant, faisons un peu de CSS.

Une des notions fondamentales est celle de sélecteur : il s'agit d'une règle appliquée par le navigateur pour rechercher des éléments (pour une référence exhaustive sur ce sujet, voir <https://developer.mozilla.org/fr/docs/Web/CSS/S%C3%A9lecteurs_CSS>).

Dans notre cas, on va faire simple et sélectionner tous les éléments de classe `cops`. Pour cela, en CSS, on va commencer par écrire cela :

```css
.cops {
  /* On va mettre nos déclarations de style ici */
}
```

En CSS, le point (`.`) qui préfixe un nom sert à sélectionner tous les éléments d'une certaine classe. Dans l'exemple ci-dessus, on sélectionne tous les éléments de classe `cops` grâce au sélecteur `.cops`.

Première chose qu'on peut faire : mettre une couleur de fond avec la propriété CSS `background`.


```css
.cops {
  background: #ee98fb;
  padding: 12pt;
  border-radius: 15px;
}
```

```{css, echo=FALSE}
.cops3 {
  background: #ee98fb;
  padding: 12pt;
  border-radius: 15px;
  border: 5px solid #883997;
}
```

::: cops3
Recommandation du COPS
:::




* Pour importer des données de taille réduite (jusqu'à 1~Go), il est recommandé d'utiliser la fonction `read_csv()` du package `readr`;
* Pour importer des données de taille plus importante (supérieure à 1~Go), il est recommandé d'utiliser la fonction `fread()` du package `data.table`.
* **Les packages suivants est déconseillé:**: voir la note de Christian, et dire que `read.csv()` n'est pas performant (ni `read.delim()`).

### Quelques détails sur les packages recommandés

#### `read_csv()` et ses cousins

options:

* encoding;
* sélection de variables;
* type des variables?

#### `fread()`

* encoding;
* choix du séparateur;
* sélection de variables;
* type des variables;
* barre de progrès.


```r
library(data.table)
df <- fread()
```


### Bonnes pratiques

Voici quelques conseils à avoir en tête pour importer des données:

* **Vérifier que votre machine peut charger les données**: `R` importe les données dans la mémoire vive de la machine. Si vos données sont d'une taille supérieure à celle de la mémoire vive, vous ne pourrez pas les importer.
* Il est important d'**importer peu de colonnes**. Bien sélectionner les colonnes permet souvent de réduire significativement la taille des données et de résoudre le problème mentionné au point précédent. Les deux `packages` recommandés permettent de sélectionner des colonnes (option `` pour `readr` et option `select` pour `data.table`)
* Choisir le package en fonction du format de sortie (`tibble` versus `data.table`)
* Bien choisir le format des colonnes.

### Ressources

* doc de fread
* doc de data.table
* éventuelle fiche sur les types de données en R.








## Importer des données depuis SAS vers `R`

### Tâches concernées / cas d'usage

L'utilisateur souhaite importer dans R des données stockées sous format SAS.

### Recommandations

* **Pour des données de taille petite ou moyenne (moins de 1 Go environ), l'usage du package `haven` est recommandé**.
* **Pour des fichiers de taille importante (plus de 1 Go environ),** il est  recommandé de procéder en deux temps:
    * Exporter les données SAS en format CSV;
    * Importer en R les données CSV.



**Les packages suivants ne sont pas recommandés pour importer des données SAS : `sas7dbat`, `foreign`, `Hmisc`, `SASxport`**.

### Quelques détails sur les packages recommandés

#### Comment utiliser `haven`?
La fonction du package `haven` à utiliser se nomme `read_sas()`

```r
library(haven)

## chargement d'une table RP depuis le lecteur GEN - environ 20"
dfRP <- read_sas("mon/chemin/de/dossier/tableSAS.sas7bdat")
```

Options de `read_sas()`

* Sélectionner les colonnes parmi celles présentes dans la base SAS

```r=
dfRP <- read_sas("W:/A1090/GEN_A1090990_DINDISAS/RPADUDIF.sas7bdat", cols_only = c("NUMERO", "ANAIX", "DPNAIX"))
```

* Obtenir la liste des labels de colonne de la table importée avec `haven`

```r=
library(sjlabelled)
get_label(dfRP)

```

* encoding - Cet argument est à renseigner uniquement si l'importation des caractères accentués se passe mal. La valeur à indiquer dépend de la source.

```r=
dfRP <- read_sas("W:/A1090/GEN_A1090990_DINDISAS/RPADUDIF.sas7bdat", encoding = "UTF-8")
```

#### Comment procéder en deux temps?

Export depuis SAS: exemple de code

```sas=
options mprint mlogic notes;

libname donnees "W:/A1090/GEN_A1090990_DINDISAS/"; 

PROC EXPORT DATA= donnees.RPADUDIF
            OUTFILE= "U:/RP.csv" 
            DBMS=CSV REPLACE;
     PUTNAMES=YES;
RUN;
```

Renvoyer à la fiche import de fichiers plats.


### Pour aller plus loin

#### Quelques conseils

* N'importer que les colonnes nécessaires.
* Les tables SAS compressées en BINARY ne sont pas prises en charge par le package `haven`. Il faut donc procéder en deux étapes (export en CSV puis import dans R)

![](https://minio.stable.innovation.insee.eu/hackmd-uploads/uploads/upload_d8c9c189eb1a11c5527374cb7b771ab0.png)


### Références

* doc de haven

```r=
library(haven)
?read_sas
```
## Manipuler des données (`dplyr` et `data.table`)

## Créer ses propres fonctions

Reprendre la partie 6 de la formation Travail collaboratif avec R.

## Ecrire des tables intermédiaires en `R` (`fst`)

## Exporter des données (quels packages?)

## Faire des graphiques (`ggplot2`)

## Traiter des données textuelles (`stringr` et une introduction aux `regex` en `R`)

## Utiliser un SGBD en `R` (`DBI` et autres drivers)

## Faire des cartes (`sf`)

## Rédiger des documents en `R` (`Rmarkdown`)
