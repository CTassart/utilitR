# Fiches de documentation

## Importer des fichiers plats (`.csv`, `.tsv`, `.txt`)

### Tâches concernées et recommandations

L'utilisateur souhaite importer dans `R` des données stockées sous forme de fichiers plats (format `.txt`, `.csv`, `.tsv`).

::: recommandation
**Recommandations de l'Insee**

* Pour importer des données de taille réduite (jusqu'à 1 Go), **il est recommandé d'utiliser la fonction `read_csv()` du package `readr`**;
* Pour importer des données de taille plus importante (supérieure à 1 Go), **il est recommandé d'utiliser la fonction `fread()` du package `data.table`**.
* **L'usage du package `csvread` est déconseillé**, de même que l'utilisation des fonctions natives de `R` `read.csv()` et `read.delim()`.
:::

### Importer des fichiers plats en `R`

#### Fichiers de taille limitée: `read_csv()`

La fonction `read_csv()` du package `readr` est adaptée pour importer des données de taille limitée (moins de 1 Go). Il faut charger le *package* `readr` pour l'utiliser:

```{r} library(readr)```.

Pour les utilisateurs débutants, `Rstudio` propose une interface très pratique pour importer des fichiers plats avec `read_csv()`. On y accède avec: `File > Import Dataset > From text (readr)...` On obtient la fenêtre suivante. En cliquant sur `Browse` (rectangle rouge), on peut définir le chemin du fichier que l'on souhaite importer.

![](./pics/Importer_csv/Interface_readr1-1.png){width=100%} 

Une fois que le fichier à importer a été sélectionné, un aperçu des premières lignes du fichier s'affiche dans la fenêtre. Dans l'exemple ci-dessous, on essaie d'importer le fichier des communes du Code Officiel Géographique (version 2019). La fenêtre comprend deux panneaux très utiles:

* Un panneau qui permet de définir les options d'importation (rectangle orange);
* Un panneau qui donne le code qui réalise l'importation demandée (rectangle vert).

![](./pics/Importer_csv/Interface_readr2-1.png){width=100%} 



::: conseil
**Conseil**

La première fois qu'on importe un fichier plat, vous pouvez vous servir de cette interface pour construire le code adapté à votre situation. Une fois que les données sont correctement importées, vous pouvez copier-coller le code dans votre script `R`. 
:::


Cette fonction comporte un certain nombre d'options. 

options:

* encoding;
* sélection de variables;
* type des variables?

#### `fread()`

* encoding;
* choix du séparateur;
* sélection de variables;
* type des variables;
* barre de progrès.


```r
library(data.table)
df <- fread()
```


### Bonnes pratiques

Voici quelques conseils à avoir en tête pour importer des données:

* **Vérifier que votre machine peut charger les données**: `R` importe les données dans la mémoire vive de la machine. Si vos données sont d'une taille supérieure à celle de la mémoire vive, vous ne pourrez pas les importer.
* Il est important d'**importer peu de colonnes**. Bien sélectionner les colonnes permet souvent de réduire significativement la taille des données et de résoudre le problème mentionné au point précédent. Les deux `packages` recommandés permettent de sélectionner des colonnes (option `` pour `readr` et option `select` pour `data.table`)
* Choisir le package en fonction du format de sortie (`tibble` versus `data.table`)
* Bien choisir le format des colonnes.

### Ressources

* doc de fread
* doc de data.table
* éventuelle fiche sur les types de données en R.


## Importer des données depuis SAS vers `R`

### Tâches concernées et recommandations

L'utilisateur souhaite importer dans `R` des données stockées sous format SAS.

::: recommandation
**Recommandations de l'Insee**

* **Pour des données de taille petite ou moyenne (moins de 1 Go), l'usage de la fonction `read_sas()` du package `haven` est recommandé.**
* **Pour des fichiers de taille importante (plus de 1 Go), il est  recommandé de procéder en deux temps**:
    * Exporter les données SAS en format `.csv`;
    * Importer en R les données `.csv`.

**Il est déconseillé d'utiliser les packages suivants pour importer des données SAS : `sas7dbat`, `foreign`, `Hmisc`, `SASxport`.**

:::



### Quelques détails sur les packages recommandés

#### Comment utiliser `haven`?
La fonction du package `haven` à utiliser se nomme `read_sas()`

```r
library(haven)

## chargement d'une table RP depuis le lecteur GEN - environ 20"
dfRP <- read_sas("mon/chemin/de/dossier/tableSAS.sas7bdat")
```

Options de `read_sas()`

* Sélectionner les colonnes parmi celles présentes dans la base SAS

```r=
dfRP <- read_sas("W:/A1090/GEN_A1090990_DINDISAS/RPADUDIF.sas7bdat", cols_only = c("NUMERO", "ANAIX", "DPNAIX"))
```

* Obtenir la liste des labels de colonne de la table importée avec `haven`

```r=
library(sjlabelled)
get_label(dfRP)

```

* encoding - Cet argument est à renseigner uniquement si l'importation des caractères accentués se passe mal. La valeur à indiquer dépend de la source.

```r=
dfRP <- read_sas("W:/A1090/GEN_A1090990_DINDISAS/RPADUDIF.sas7bdat", encoding = "UTF-8")
```

#### Comment procéder en deux temps?

Export depuis SAS: exemple de code

```sas=
options mprint mlogic notes;

libname donnees "W:/A1090/GEN_A1090990_DINDISAS/"; 

PROC EXPORT DATA= donnees.RPADUDIF
            OUTFILE= "U:/RP.csv" 
            DBMS=CSV REPLACE;
     PUTNAMES=YES;
RUN;
```

Renvoyer à la fiche import de fichiers plats.


### Pour aller plus loin

#### Quelques conseils

* N'importer que les colonnes nécessaires.
* Les tables SAS compressées en BINARY ne sont pas prises en charge par le package `haven`. Il faut donc procéder en deux étapes (export en CSV puis import dans R)

![](https://minio.stable.innovation.insee.eu/hackmd-uploads/uploads/upload_d8c9c189eb1a11c5527374cb7b771ab0.png)


### Références

* doc de haven

```r=
library(haven)
?read_sas
```
## Manipuler des données (`dplyr` et `data.table`)

## Créer ses propres fonctions

Reprendre la partie 6 de la formation Travail collaboratif avec R.

## Ecrire des tables intermédiaires en `R` (`fst`)

## Exporter des données (quels packages?)

## Faire des graphiques (`ggplot2`)

## Traiter des données textuelles (`stringr` et une introduction aux `regex` en `R`)

## Utiliser un SGBD en `R` (`DBI` et autres drivers)

## Réaliser des cartes

### Tâches concernées et recommandations

L'utilisateur souhaite A COMPLETER.



::: recommandation
**Recommandations de l'Insee**

* Pour faire des cartes, il est recommandé d'utiliser des outils cartographiques.

:::

### Introduction à la cartographie avec `R` et `sf`/`sp`/`le bon package`




### Bonnes pratiques



### Ressources

* la doc des packages;
* les supports de formation à l'Insee;
* les supports de formation externes;
* les bons sites ressources (tutoriels, galeries, forums...)



## Rédiger des documents en `R` (`Rmarkdown`)
